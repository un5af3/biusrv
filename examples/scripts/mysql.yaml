info:
  name: mysql
  desc: Database server

script:
  install:
    desc: Install and configure MySQL
    step:
      - type: command
        sudo: true
        cmds:
          - apt update
          - apt install -y mysql-server
          - systemctl enable mysql

      - type: command
        sudo: true
        cmds:
          - |
            mysql_secure_installation <<EOF
            n
            password123
            password123
            y
            y
            y
            y
            EOF

      - type: upload
        local: ./configs/mysql.cnf
        remote: /etc/mysql/mysql.conf.d/mysqld.cnf
        force: true

      - type: command
        sudo: true
        cmds:
          - systemctl restart mysql
          - systemctl status mysql

  backup:
    desc: Backup MySQL databases
    step:
      - type: command
        sudo: true
        cmds:
          - mkdir -p /tmp/mysql-backup
          - mysqldump --all-databases > /tmp/mysql-backup/all-databases.sql

      - type: download
        local: ./backups/mysql/
        remote: /tmp/mysql-backup/
        resume: true

      - type: command
        sudo: true
        cmds:
          - rm -rf /tmp/mysql-backup
